<!DOCTYPE html>
<html lang="vi">
<head>
    <script src="analytics.js"></script>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>B√†i t·∫≠p Ng·ªØ ph√°p B√†i 1 - Ti·∫øng H√†n Hyewon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Common CSS -->
    <link rel="stylesheet" href="css/grammar-common.css">
    <link rel="stylesheet" href="css/grammar-exercise.css">
</head>
<body>
    <div class="header-bar">
        <button class="back-button" onclick="goToIndex()">
            <span class="back-arrow">‚Üê</span>
            <span>Quay l·∫°i</span>
        </button>
        <span id="lesson-name" class="lesson-title">B√†i 1: Gi·ªõi thi·ªáu</span>
    </div>

    <div id="quiz-container" class="main-container text-center">
        <div id="question-counter" class="question-counter">C√¢u 1/10</div>
        <div class="question-container">
            <button id="replay-audio-btn" style="display: none;">üîä</button>
            <div id="sentence-container" class="korean-text sentence-text leading-loose">
            </div>
        </div>
        <div id="word-bank" class="word-bank"></div>
        <div class="controls">
            <button id="check-btn" class="btn btn-primary">Ki·ªÉm tra</button>
            <button id="next-btn" class="btn btn-primary">C√¢u ti·∫øp theo</button>
        </div>
        <div id="feedback" class="feedback" style="display: none;"></div>
        <div id="explanation" class="explanation" style="display: none;"></div>
    </div>

    <!-- Common JavaScript -->
    <script src="js/grammar-common.js"></script>
    <script src="js/grammar-audio-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load voices for speech synthesis
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }

            // --- DOM ELEMENTS ---
            const lessonName = document.getElementById('lesson-name');
            const questionCounter = document.getElementById('question-counter');
            const sentenceContainer = document.getElementById('sentence-container');
            const wordBank = document.getElementById('word-bank');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const explanationEl = document.getElementById('explanation');
            const replayAudioBtn = document.getElementById('replay-audio-btn');

            // --- APP STATE ---
            let currentExercises = [];
            let currentQuestion = null;
            let hasAnswered = false;
            let currentQuestionIndex = 0;
            let totalQuestions = 0;
            let correctAnswers = 0; // Track correct answers count
            let isRetake = false; // Track if this is a retake

            // Lesson 1 Exercise data
            const exerciseData = {
                title: "B√†i 1: Gi·ªõi thi·ªáu",
                exercises: [
                    {
                        id: "lesson1_q1",
                        template: "Ï†ÄÎäî ___ ÏûÖÎãàÎã§.",
                        translation: "T√¥i l√† h·ªçc sinh",
                        choices: ["ÌïôÏÉù", "ÏÑ†ÏÉùÎãò", "ÏùòÏÇ¨", "ÌöåÏÇ¨Ïõê"],
                        solution: ["ÌïôÏÉù"],
                        completeSentence: "Ï†ÄÎäî ÌïôÏÉùÏûÖÎãàÎã§",
                        explanation: "ÌïôÏÉù = h·ªçc sinh. ÏûÖÎãàÎã§ l√† d·∫°ng l·ªãch s·ª± c·ªßa ƒë·ªông t·ª´ 'l√†'."
                    },
                    {
                        id: "lesson1_q2",
                        template: "Ï†ú Ïù¥Î¶Ñ___ ÍπÄÎØºÏàòÏûÖÎãàÎã§.",
                        translation: "T√™n t√¥i l√† Kim Min Soo",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "Ï†ú Ïù¥Î¶ÑÏùÄ ÍπÄÎØºÏàòÏûÖÎãàÎã§",
                        explanation: "Ïù¥Î¶Ñ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „ÖÅ ‚Üí d√πng ÏùÄ."
                    },
                    {
                        id: "lesson1_q3",
                        template: "ÏÑ†ÏÉùÎãò___ ÌïúÍµ≠ ÏÇ¨ÎûåÏûÖÎãàÎã§.",
                        translation: "Gi√°o vi√™n l√† ng∆∞·ªùi H√†n Qu·ªëc",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "ÏÑ†ÏÉùÎãòÏùÄ ÌïúÍµ≠ ÏÇ¨ÎûåÏûÖÎãàÎã§",
                        explanation: "ÏÑ†ÏÉùÎãò k·∫øt th√∫c b·∫±ng ph·ª• √¢m „ÖÅ ‚Üí d√πng ÏùÄ."
                    },
                    {
                        id: "lesson1_q4",
                        template: "Ï†Ä___ ÏùòÏÇ¨ÏûÖÎãàÎã§.",
                        translation: "T√¥i l√† b√°c sƒ©",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Îäî"],
                        completeSentence: "Ï†ÄÎäî ÏùòÏÇ¨ÏûÖÎãàÎã§",
                        explanation: "Ï†Ä k·∫øt th√∫c b·∫±ng nguy√™n √¢m „Öì ‚Üí d√πng Îäî."
                    },
                    {
                        id: "lesson1_q5",
                        template: "ÌïôÏÉù___?",
                        translation: "C√≥ ph·∫£i l√† h·ªçc sinh kh√¥ng?",
                        choices: ["ÏûÖÎãàÎã§", "ÏûÖÎãàÍπå", "ÏïÑÎãôÎãàÎã§", "Îê©ÎãàÎã§"],
                        solution: ["ÏûÖÎãàÍπå"],
                        completeSentence: "ÌïôÏÉùÏûÖÎãàÍπå?",
                        explanation: "ÏûÖÎãàÍπå l√† d·∫°ng nghi v·∫•n l·ªãch s·ª± c·ªßa ÏûÖÎãàÎã§."
                    },
                    {
                        id: "lesson1_q6",
                        template: "ÏïÑÎãàÏöî, ÌïôÏÉùÏù¥ ___.",
                        translation: "Kh√¥ng, kh√¥ng ph·∫£i h·ªçc sinh",
                        choices: ["ÏûÖÎãàÎã§", "ÏûÖÎãàÍπå", "ÏïÑÎãôÎãàÎã§", "Îê©ÎãàÎã§"],
                        solution: ["ÏïÑÎãôÎãàÎã§"],
                        completeSentence: "ÏïÑÎãàÏöî, ÌïôÏÉùÏù¥ ÏïÑÎãôÎãàÎã§",
                        explanation: "ÏïÑÎãôÎãàÎã§ ƒë∆∞·ª£c d√πng ƒë·ªÉ ph·ªß ƒë·ªãnh m·ªôt c√°ch l·ªãch s·ª±."
                    },
                    {
                        id: "lesson1_q7",
                        template: "ÎàÑÎÇò___ ÌöåÏÇ¨ÏõêÏûÖÎãàÎã§.",
                        translation: "Ch·ªã g√°i l√† nh√¢n vi√™n c√¥ng ty",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Îäî"],
                        completeSentence: "ÎàÑÎÇòÎäî ÌöåÏÇ¨ÏõêÏûÖÎãàÎã§",
                        explanation: "ÎàÑÎÇò k·∫øt th√∫c b·∫±ng nguy√™n √¢m „Öè ‚Üí d√πng Îäî."
                    },
                    {
                        id: "lesson1_q8",
                        template: "Ïù¥Î∂Ñ___ ÏÑ†ÏÉùÎãòÏûÖÎãàÎã§.",
                        translation: "Ng∆∞·ªùi n√†y l√† gi√°o vi√™n",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "Ïù¥Î∂ÑÏùÄ ÏÑ†ÏÉùÎãòÏûÖÎãàÎã§",
                        explanation: "Ïù¥Î∂Ñ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñ¥ ‚Üí d√πng ÏùÄ."
                    },
                    {
                        id: "lesson1_q9",
                        template: "ÎÑ§, ___ÏûÖÎãàÎã§.",
                        translation: "V√¢ng, ƒë√∫ng v·∫≠y (l√† h·ªçc sinh)",
                        choices: ["ÌïôÏÉù", "ÏÑ†ÏÉùÎãò", "ÏùòÏÇ¨", "Í∞ÑÌò∏ÏÇ¨"],
                        solution: ["ÌïôÏÉù"],
                        completeSentence: "ÎÑ§, ÌïôÏÉùÏûÖÎãàÎã§",
                        explanation: "ÎÑ§ = v√¢ng. ƒê√¢y l√† c√°ch tr·∫£ l·ªùi kh·∫≥ng ƒë·ªãnh khi ƒë∆∞·ª£c h·ªèi ÌïôÏÉùÏûÖÎãàÍπå?"
                    },
                    {
                        id: "lesson1_q10",
                        template: "Ï†ÄÎäî ___ ÏÇ¨ÎûåÏûÖÎãàÎã§.",
                        translation: "T√¥i l√† ng∆∞·ªùi Vi·ªát Nam",
                        choices: ["ÌïúÍµ≠", "ÏùºÎ≥∏", "Î≤†Ìä∏ÎÇ®", "Ï§ëÍµ≠"],
                        solution: ["Î≤†Ìä∏ÎÇ®"],
                        completeSentence: "Ï†ÄÎäî Î≤†Ìä∏ÎÇ® ÏÇ¨ÎûåÏûÖÎãàÎã§",
                        explanation: "Î≤†Ìä∏ÎÇ® = Vi·ªát Nam. Î≤†Ìä∏ÎÇ® ÏÇ¨Îûå = ng∆∞·ªùi Vi·ªát Nam."
                    }
                ]
            };

            /**
             * Initialize the quiz
             */
            function initializeQuiz() {
                // Check if this is a retake (from localStorage or URL parameter)
                const params = new URLSearchParams(window.location.search);
                isRetake = localStorage.getItem('lesson_lesson1_completed') === 'true' || 
                          params.get('retake') === 'true';
                
                currentExercises = [...exerciseData.exercises];
                totalQuestions = currentExercises.length;
                
                // Shuffle exercises for variety
                if (isRetake || Math.random() > 0.5) {
                    currentExercises = shuffleArray(currentExercises);
                }
                
                loadNextQuestion();
            }

            function updateQuestionCounter() {
                questionCounter.textContent = `C√¢u ${currentQuestionIndex + 1}/${totalQuestions}`;
            }

            function loadNextQuestion() {
                if (currentQuestionIndex >= totalQuestions) {
                    showResultsPage();
                    return;
                }

                currentQuestion = currentExercises[currentQuestionIndex];
                hasAnswered = false;
                
                // Set global reference for audio manager
                window.currentQuestion = currentQuestion;

                // Update counter
                updateQuestionCounter();

                // Build sentence with blanks
                buildSentence();
                
                // Build word bank
                buildWordBank();

                // Reset buttons
                checkBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                
                // Hide feedback and explanation
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';

                // Hide audio button initially - only show after answering
                replayAudioBtn.style.display = 'none';
            }

            function buildSentence() {
                const template = currentQuestion.template;
                const translation = currentQuestion.translation;
                
                // Create sentence with blanks
                let sentenceHtml = template.replace(/_+/g, '<span class="blank" onclick="handleBlankClick(this)"></span>');
                
                sentenceContainer.innerHTML = `
                    <div class="korean-text sentence-text">${sentenceHtml}</div>
                    <div class="translation-text">${translation}</div>
                `;
            }

            function buildWordBank() {
                const choices = shuffleArray([...currentQuestion.choices]);
                
                wordBank.innerHTML = choices.map(choice => 
                    `<button class="word-btn korean-text" onclick="handleWordSelection(this)">${choice}</button>`
                ).join('');
            }

            // Move these functions to global scope
            window.handleWordSelection = function(wordBtn) {
                if (hasAnswered) return;
                
                const word = wordBtn.textContent;
                const blanks = document.querySelectorAll('.blank');
                
                // Find first empty blank
                const emptyBlank = Array.from(blanks).find(blank => !blank.textContent.trim());
                if (emptyBlank) {
                    emptyBlank.textContent = word;
                    wordBtn.disabled = true;
                }
            };
            
            window.handleBlankClick = function(clickedBlank) {
                if (hasAnswered) return;
                
                const word = clickedBlank.textContent.trim();
                if (word) {
                    // Return word to word bank
                    const wordBtns = document.querySelectorAll('.word-btn');
                    const matchingBtn = Array.from(wordBtns).find(btn => btn.textContent === word && btn.disabled);
                    if (matchingBtn) {
                        matchingBtn.disabled = false;
                    }
                    clickedBlank.textContent = '';
                }
            };

            function playCurrentQuestionAudio() {
                if (!currentQuestion) return;
                
                // Use the new grammar audio manager with dual voice support
                window.grammarAudioManager.playQuestionAudio(currentQuestion.id);
            }

            function checkAnswers() {
                if (hasAnswered) return;
                
                const blanks = document.querySelectorAll('.blank');
                const userAnswers = Array.from(blanks).map(blank => blank.textContent.trim());
                const correctSolution = currentQuestion.solution;
                
                hasAnswered = true;
                
                let isCorrect = true;
                blanks.forEach((blank, index) => {
                    const userAnswer = blank.textContent.trim();
                    const correctAnswer = correctSolution[index];
                    
                    if (userAnswer === correctAnswer) {
                        blank.classList.add('correct');
                    } else {
                        blank.classList.add('incorrect');
                        isCorrect = false;
                    }
                });
                
                // Show feedback
                feedbackEl.style.display = 'block';
                if (isCorrect) {
                    feedbackEl.textContent = 'Ï†ïÎãµÏûÖÎãàÎã§! (Ch√≠nh x√°c!)';
                    feedbackEl.className = 'feedback success';
                    correctAnswers++;
                } else {
                    feedbackEl.textContent = 'ÌãÄÎ†∏ÏäµÎãàÎã§. (Sai r·ªìi.)';
                    feedbackEl.className = 'feedback error';
                }
                
                // Show explanation
                explanationEl.style.display = 'block';
                explanationEl.innerHTML = `
                    <h4>Gi·∫£i th√≠ch:</h4>
                    <p><strong>C√¢u ƒë√∫ng:</strong> <span class="korean">${currentQuestion.completeSentence}</span></p>
                    <p>${currentQuestion.explanation}</p>
                `;
                
                // Update buttons
                checkBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                
                // Show audio button and setup click handler
                replayAudioBtn.style.display = 'block';
                replayAudioBtn.onclick = playCurrentQuestionAudio;
                
                // Disable word buttons
                const wordBtns = document.querySelectorAll('.word-btn');
                wordBtns.forEach(btn => btn.disabled = true);
                
                // Auto-play audio after answering
                setTimeout(() => {
                    playCurrentQuestionAudio();
                }, 500);
                
                // Setup next button
                nextBtn.onclick = () => {
                    currentQuestionIndex++;
                    loadNextQuestion();
                };
            }

            function showResultsPage() {
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                const passed = percentage >= 70;
                
                // Save completion status
                if (passed) {
                    localStorage.setItem('lesson_lesson1_completed', 'true');
                }
                
                sentenceContainer.innerHTML = `
                    <div class="results-content">
                        <div class="completion-icon">${passed ? 'üéâ' : 'üìö'}</div>
                        <h2>${passed ? 'Ch√∫c m·ª´ng!' : 'C·∫ßn √¥n t·∫≠p th√™m'}</h2>
                        <p class="results-score">ƒêi·ªÉm s·ªë: ${correctAnswers}/${totalQuestions} (${percentage}%)</p>
                        <p class="results-message">
                            ${passed ? 
                                'B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc b√†i t·∫≠p ng·ªØ ph√°p B√†i 1!' : 
                                'H√£y √¥n t·∫≠p l·∫°i l√Ω thuy·∫øt v√† th·ª≠ l·∫°i nh√©!'
                            }
                        </p>
                        <div class="results-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="restartLesson()">L√†m l·∫°i</button>
                            <button class="btn btn-secondary" onclick="goToIndex()">V·ªÅ trang ch·ªß</button>
                            ${passed ? '<button class="btn btn-primary" onclick="window.location.href=\'grammar-lesson1-theory.html\'">Xem l√Ω thuy·∫øt</button>' : ''}
                        </div>
                    </div>
                `;
                
                // Hide other elements
                wordBank.style.display = 'none';
                document.querySelector('.controls').style.display = 'none';
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';
                replayAudioBtn.style.display = 'none';
                questionCounter.style.display = 'none';
            }

            // --- EVENT LISTENERS ---
            checkBtn.addEventListener('click', checkAnswers);
            initializeQuiz();
        });

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function restartLesson() {
            window.location.reload();
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>
</html>
