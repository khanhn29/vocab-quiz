<!DOCTYPE html>
<html lang="vi">
<head>
    <script src="analytics.js"></script>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>B√†i t·∫≠p Ng·ªØ ph√°p B√†i 2 - Ti·∫øng H√†n Hyewon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Common CSS -->
    <link rel="stylesheet" href="css/grammar-common.css">
    <link rel="stylesheet" href="css/grammar-exercise.css">
</head>
<body>
    <div class="header-bar">
        <button class="back-button" onclick="goToIndex()">
            <span class="back-arrow">‚Üê</span>
            <span>Quay l·∫°i</span>
        </button>
        <span id="lesson-name" class="lesson-title">B√†i 2: Tr∆∞·ªùng h·ªçc</span>
    </div>

    <div id="quiz-container" class="main-container text-center">
        <div id="question-counter" class="question-counter">C√¢u 1/10</div>
        <div class="question-container">
            <button id="replay-audio-btn" style="display: none;">üîä</button>
            <div id="sentence-container" class="korean-text sentence-text leading-loose">
            </div>
        </div>
        <div id="word-bank" class="word-bank"></div>
        <div class="controls">
            <button id="check-btn" class="btn btn-primary">Ki·ªÉm tra</button>
            <button id="next-btn" class="btn btn-primary">C√¢u ti·∫øp theo</button>
        </div>
        <div id="feedback" class="feedback" style="display: none;"></div>
        <div id="explanation" class="explanation" style="display: none;"></div>
    </div>

    <!-- Common JavaScript -->
    <script src="js/grammar-common.js"></script>
    <script src="js/grammar-audio-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load voices for speech synthesis
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }

            // --- DOM ELEMENTS ---
            const lessonName = document.getElementById('lesson-name');
            const questionCounter = document.getElementById('question-counter');
            const sentenceContainer = document.getElementById('sentence-container');
            const wordBank = document.getElementById('word-bank');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const explanationEl = document.getElementById('explanation');
            const replayAudioBtn = document.getElementById('replay-audio-btn');

            // --- APP STATE ---
            let currentExercises = [];
            let currentQuestion = null;
            let hasAnswered = false;
            let currentQuestionIndex = 0;
            let totalQuestions = 0;
            let correctAnswers = 0; // Track correct answers count
            let isRetake = false; // Track if this is a retake

            // Lesson 2 Exercise data
            const exerciseData = {
                title: "B√†i 2: Tr∆∞·ªùng h·ªçc",
                exercises: [
                    {
                        id: "lesson2_q1",
                        template: "ÍµêÏã§___ Ïñ¥ÎîîÏóê ÏûàÏäµÎãàÍπå?",
                        translation: "Ph√≤ng h·ªçc ·ªü ƒë√¢u?",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Ïù¥"],
                        completeSentence: "ÍµêÏã§Ïù¥ Ïñ¥ÎîîÏóê ÏûàÏäµÎãàÍπå?",
                        explanation: "ÍµêÏã§ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñπ ‚Üí d√πng Ïù¥ (ch·ªß ng·ªØ)."
                    },
                    {
                        id: "lesson2_q2",
                        template: "ÎèÑÏÑúÍ¥Ä___ 2Ï∏µÏóê ÏûàÏäµÎãàÎã§.",
                        translation: "Th∆∞ vi·ªán ·ªü t·∫ßng 2",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "ÎèÑÏÑúÍ¥ÄÏùÄ 2Ï∏µÏóê ÏûàÏäµÎãàÎã§",
                        explanation: "ÎèÑÏÑúÍ¥Ä k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñ¥ ‚Üí d√πng ÏùÄ (ch·ªß ƒë·ªÅ)."
                    },
                    {
                        id: "lesson2_q3",
                        template: "ÌïôÏÉù___ Ïñ¥ÎîîÏóê ÏûàÏäµÎãàÍπå?",
                        translation: "H·ªçc sinh ·ªü ƒë√¢u?",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Ïù¥"],
                        completeSentence: "ÌïôÏÉùÏù¥ Ïñ¥ÎîîÏóê ÏûàÏäµÎãàÍπå?",
                        explanation: "ÌïôÏÉù k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Öá ‚Üí d√πng Ïù¥ (ch·ªß ng·ªØ)."
                    },
                    {
                        id: "lesson2_q4",
                        template: "ÏùòÏûê___ ÍµêÏã§Ïóê ÏûàÏäµÎãàÎã§.",
                        translation: "Gh·∫ø ·ªü trong ph√≤ng h·ªçc",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Îäî"],
                        completeSentence: "ÏùòÏûêÎäî ÍµêÏã§Ïóê ÏûàÏäµÎãàÎã§",
                        explanation: "ÏùòÏûê k·∫øt th√∫c b·∫±ng nguy√™n √¢m „Öè ‚Üí d√πng Îäî (ch·ªß ƒë·ªÅ)."
                    },
                    {
                        id: "lesson2_q5",
                        template: "Ï±ÖÏÉÅ___ Î¨¥ÏóáÏûÖÎãàÍπå?",
                        translation: "B√†n h·ªçc l√† g√¨?",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "Ï±ÖÏÉÅÏùÄ Î¨¥ÏóáÏûÖÎãàÍπå?",
                        explanation: "Ï±ÖÏÉÅ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Öá ‚Üí d√πng ÏùÄ (ch·ªß ƒë·ªÅ)."
                    },
                    {
                        id: "lesson2_q6",
                        template: "Ïπ†Ìåê___ Ïñ¥ÎîîÏóê ÏûàÏäµÎãàÍπå?",
                        translation: "B·∫£ng ƒëen ·ªü ƒë√¢u?",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Ïù¥"],
                        completeSentence: "Ïπ†ÌåêÏù¥ Ïñ¥ÎîîÏóê ÏûàÏäµÎãàÍπå?",
                        explanation: "Ïπ†Ìåê k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñ¥ ‚Üí d√πng Ïù¥ (ch·ªß ng·ªØ)."
                    },
                    {
                        id: "lesson2_q7",
                        template: "Ïª¥Ìì®ÌÑ∞___ ÏûàÏäµÎãàÎã§.",
                        translation: "C√≥ m√°y t√≠nh",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["Í∞Ä"],
                        completeSentence: "Ïª¥Ìì®ÌÑ∞Í∞Ä ÏûàÏäµÎãàÎã§",
                        explanation: "Ïª¥Ìì®ÌÑ∞ k·∫øt th√∫c b·∫±ng nguy√™n √¢m „Öì ‚Üí d√πng Í∞Ä (ch·ªß ng·ªØ v·ªõi ÏûàÏäµÎãàÎã§)."
                    },
                    {
                        id: "lesson2_q8",
                        template: "Í∞ïÏùòÏã§___ 3Ï∏µÏóê ÏûàÏäµÎãàÎã§.",
                        translation: "Ph√≤ng gi·∫£ng ·ªü t·∫ßng 3",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "Í∞ïÏùòÏã§ÏùÄ 3Ï∏µÏóê ÏûàÏäµÎãàÎã§",
                        explanation: "Í∞ïÏùòÏã§ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñπ ‚Üí d√πng ÏùÄ (ch·ªß ƒë·ªÅ)."
                    },
                    {
                        id: "lesson2_q9",
                        template: "ÏÑ†ÏÉùÎãò___ ÍµêÏã§Ïóê Í≥ÑÏã≠ÎãàÎã§.",
                        translation: "Th·∫ßy/c√¥ ·ªü trong ph√≤ng h·ªçc",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "ÍªòÏÑú"],
                        solution: ["ÍªòÏÑú"],
                        completeSentence: "ÏÑ†ÏÉùÎãòÍªòÏÑú ÍµêÏã§Ïóê Í≥ÑÏã≠ÎãàÎã§",
                        explanation: "ÍªòÏÑú l√† d·∫°ng t√¥n k√≠nh c·ªßa Ïù¥/Í∞Ä, d√πng v·ªõi ng∆∞·ªùi ƒë∆∞·ª£c t√¥n tr·ªçng."
                    },
                    {
                        id: "lesson2_q10",
                        template: "ÏãùÎãπ___ 1Ï∏µÏóê ÏûàÏäµÎãàÎã§.",
                        translation: "Nh√† ƒÉn ·ªü t·∫ßng 1",
                        choices: ["ÏùÄ", "Îäî", "Ïù¥", "Í∞Ä"],
                        solution: ["ÏùÄ"],
                        completeSentence: "ÏãùÎãπÏùÄ 1Ï∏µÏóê ÏûàÏäµÎãàÎã§",
                        explanation: "ÏãùÎãπ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Öá ‚Üí d√πng ÏùÄ (ch·ªß ƒë·ªÅ)."
                    }
                ]
            };

            /**
             * Initialize the quiz
             */
            function initializeQuiz() {
                // Check if this is a retake (from localStorage or URL parameter)
                const params = new URLSearchParams(window.location.search);
                isRetake = localStorage.getItem('lesson_lesson2_completed') === 'true' || 
                          params.get('retake') === 'true';
                
                currentExercises = [...exerciseData.exercises];
                totalQuestions = currentExercises.length;
                
                // Shuffle exercises for variety
                if (isRetake || Math.random() > 0.5) {
                    currentExercises = shuffleArray(currentExercises);
                }
                
                loadNextQuestion();
            }

            function updateQuestionCounter() {
                questionCounter.textContent = `C√¢u ${currentQuestionIndex + 1}/${totalQuestions}`;
            }

            function loadNextQuestion() {
                if (currentQuestionIndex >= totalQuestions) {
                    showResultsPage();
                    return;
                }

                currentQuestion = currentExercises[currentQuestionIndex];
                hasAnswered = false;
                
                // Set global reference for audio manager
                window.currentQuestion = currentQuestion;

                // Update counter
                updateQuestionCounter();

                // Build sentence with blanks
                buildSentence();
                
                // Build word bank
                buildWordBank();

                // Reset buttons
                checkBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                
                // Hide feedback and explanation
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';

                // Show and setup audio button
                replayAudioBtn.style.display = 'block';
                replayAudioBtn.onclick = playCurrentQuestionAudio;
                
                // Auto-play audio for new question
                setTimeout(() => {
                    playCurrentQuestionAudio();
                }, 500);
            }

            function buildSentence() {
                const template = currentQuestion.template;
                const translation = currentQuestion.translation;
                
                // Create sentence with blanks
                let sentenceHtml = template.replace(/_+/g, '<span class="blank" onclick="handleBlankClick(this)"></span>');
                
                sentenceContainer.innerHTML = `
                    <div class="korean-text sentence-text">${sentenceHtml}</div>
                    <div class="translation-text">${translation}</div>
                `;
            }

            function buildWordBank() {
                const choices = shuffleArray([...currentQuestion.choices]);
                
                wordBank.innerHTML = choices.map(choice => 
                    `<button class="word-btn korean-text" onclick="handleWordSelection(this)">${choice}</button>`
                ).join('');
            }

            function handleWordSelection(wordBtn) {
                if (hasAnswered) return;
                
                const word = wordBtn.textContent;
                const blanks = document.querySelectorAll('.blank');
                
                // Find first empty blank
                const emptyBlank = Array.from(blanks).find(blank => !blank.textContent.trim());
                if (emptyBlank) {
                    emptyBlank.textContent = word;
                    wordBtn.disabled = true;
                }
            }
            
            function handleBlankClick(clickedBlank) {
                if (hasAnswered) return;
                
                const word = clickedBlank.textContent.trim();
                if (word) {
                    // Return word to word bank
                    const wordBtns = document.querySelectorAll('.word-btn');
                    const matchingBtn = Array.from(wordBtns).find(btn => btn.textContent === word && btn.disabled);
                    if (matchingBtn) {
                        matchingBtn.disabled = false;
                    }
                    clickedBlank.textContent = '';
                }
            }

            function playCurrentQuestionAudio() {
                if (!currentQuestion) return;
                
                // Use the new grammar audio manager with dual voice support
                window.grammarAudioManager.playQuestionAudio(currentQuestion.id);
            }

            function checkAnswers() {
                if (hasAnswered) return;
                
                const blanks = document.querySelectorAll('.blank');
                const userAnswers = Array.from(blanks).map(blank => blank.textContent.trim());
                const correctAnswers = currentQuestion.solution;
                
                hasAnswered = true;
                
                let isCorrect = true;
                blanks.forEach((blank, index) => {
                    const userAnswer = blank.textContent.trim();
                    const correctAnswer = correctAnswers[index];
                    
                    if (userAnswer === correctAnswer) {
                        blank.classList.add('correct');
                    } else {
                        blank.classList.add('incorrect');
                        isCorrect = false;
                    }
                });
                
                // Show feedback
                feedbackEl.style.display = 'block';
                if (isCorrect) {
                    feedbackEl.textContent = 'Ï†ïÎãµÏûÖÎãàÎã§! (Ch√≠nh x√°c!)';
                    feedbackEl.className = 'feedback success';
                    correctAnswers++;
                } else {
                    feedbackEl.textContent = 'ÌãÄÎ†∏ÏäµÎãàÎã§. (Sai r·ªìi.)';
                    feedbackEl.className = 'feedback error';
                }
                
                // Show explanation
                explanationEl.style.display = 'block';
                explanationEl.innerHTML = `
                    <h4>Gi·∫£i th√≠ch:</h4>
                    <p><strong>C√¢u ƒë√∫ng:</strong> <span class="korean">${currentQuestion.completeSentence}</span></p>
                    <p>${currentQuestion.explanation}</p>
                `;
                
                // Update buttons
                checkBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                
                // Disable word buttons
                const wordBtns = document.querySelectorAll('.word-btn');
                wordBtns.forEach(btn => btn.disabled = true);
                
                // Setup next button
                nextBtn.onclick = () => {
                    currentQuestionIndex++;
                    loadNextQuestion();
                };
            }

            function showResultsPage() {
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                const passed = percentage >= 70;
                
                // Save completion status
                if (passed) {
                    localStorage.setItem('lesson_lesson2_completed', 'true');
                }
                
                sentenceContainer.innerHTML = `
                    <div class="results-content">
                        <div class="completion-icon">${passed ? 'üéâ' : 'üìö'}</div>
                        <h2>${passed ? 'Ch√∫c m·ª´ng!' : 'C·∫ßn √¥n t·∫≠p th√™m'}</h2>
                        <p class="results-score">ƒêi·ªÉm s·ªë: ${correctAnswers}/${totalQuestions} (${percentage}%)</p>
                        <p class="results-message">
                            ${passed ? 
                                'B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc b√†i t·∫≠p ng·ªØ ph√°p B√†i 2!' : 
                                'H√£y √¥n t·∫≠p l·∫°i l√Ω thuy·∫øt v√† th·ª≠ l·∫°i nh√©!'
                            }
                        </p>
                        <div class="results-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="restartLesson()">L√†m l·∫°i</button>
                            <button class="btn btn-secondary" onclick="goToIndex()">V·ªÅ trang ch·ªß</button>
                            ${passed ? '<button class="btn btn-primary" onclick="window.location.href=\'grammar-lesson2-theory.html\'">Xem l√Ω thuy·∫øt</button>' : ''}
                        </div>
                    </div>
                `;
                
                // Hide other elements
                wordBank.style.display = 'none';
                document.querySelector('.controls').style.display = 'none';
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';
                replayAudioBtn.style.display = 'none';
                questionCounter.style.display = 'none';
            }

            // --- EVENT LISTENERS ---
            checkBtn.addEventListener('click', checkAnswers);
            initializeQuiz();
        });

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function restartLesson() {
            window.location.reload();
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>
</html>
