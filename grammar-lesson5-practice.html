<!DOCTYPE html>
<html lang="vi">
<head>
    <script src="analytics.js"></script>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BÃ i táº­p Ngá»¯ phÃ¡p BÃ i 5 - Tiáº¿ng HÃ n Hyewon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Common CSS -->
    <link rel="stylesheet" href="css/grammar-common.css">
    <link rel="stylesheet" href="css/grammar-exercise.css">
</head>
<body>
    <div class="header-bar">
        <button class="back-button" onclick="goToIndex()">
            <span class="back-arrow">â†</span>
            <span>Quay láº¡i</span>
        </button>
        <span id="lesson-name" class="lesson-title">BÃ i 5: í•˜ë£¨ ì¼ê³¼ (CÃ´ng Viá»‡c Trong NgÃ y)</span>
    </div>

    <div id="quiz-container" class="main-container text-center">
        <div id="question-counter" class="question-counter">CÃ¢u 1/10</div>
        <div class="question-container">
            <button id="replay-audio-btn" style="display: none;">ğŸ”Š</button>
            <div id="sentence-container" class="korean-text sentence-text leading-loose">
            </div>
        </div>
        <div id="word-bank" class="word-bank"></div>
        <div class="controls">
            <button id="check-btn" class="btn btn-primary">Kiá»ƒm tra</button>
            <button id="next-btn" class="btn btn-primary">CÃ¢u tiáº¿p theo</button>
        </div>
        <div id="feedback" class="feedback" style="display: none;"></div>
        <div id="explanation" class="explanation" style="display: none;"></div>
    </div>

    <!-- Common JavaScript -->
    <script src="js/grammar-common.js"></script>
    <script src="js/grammar-audio-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load voices for speech synthesis
            if ('speechSynthesis' in window) {
                // Load voices
                let voices = window.speechSynthesis.getVoices();
                
                // If voices are not loaded yet, wait for the voiceschanged event
                if (voices.length === 0) {
                    window.speechSynthesis.addEventListener('voiceschanged', function() {
                        voices = window.speechSynthesis.getVoices();
                        console.log('Available voices loaded:', voices.filter(v => v.lang.startsWith('ko')).length, 'Korean voices');
                    });
                } else {
                    console.log('Available voices:', voices.filter(v => v.lang.startsWith('ko')).length, 'Korean voices');
                }
            }

            // --- DOM ELEMENTS ---
            const lessonName = document.getElementById('lesson-name');
            const questionCounter = document.getElementById('question-counter');
            const sentenceContainer = document.getElementById('sentence-container');
            const wordBank = document.getElementById('word-bank');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const explanationEl = document.getElementById('explanation');
            const replayAudioBtn = document.getElementById('replay-audio-btn');

            // --- APP STATE ---
            let currentExercises = [];
            let currentQuestion = null;
            let hasAnswered = false;
            let currentQuestionIndex = 0;
            let totalQuestions = 0;
            let correctAnswers = 0; // Track correct answers count
            let isRetake = false; // Track if this is a retake

            // Lesson 5 Exercise data
            const exerciseData = {
                title: "BÃ i 5: í•˜ë£¨ ì¼ê³¼ (CÃ´ng Viá»‡c Trong NgÃ y)",
                exercises: [
                    {
                        id: "lesson5_q1",
                        template: "__ ì‹œì— ì¼ì–´ë‚˜ìš”.",
                        translation: "TÃ´i thá»©c dáº­y lÃºc 7 giá»",
                        choices: ["ì¼ê³±", "ì¹ ", "ì„¸ë¸", "ì—¬ëŸ"],
                        solution: ["ì¼ê³±"],
                        completeSentence: "ì¼ê³± ì‹œì— ì¼ì–´ë‚˜ìš”",
                        explanation: "Khi nÃ³i vá» giá», ta dÃ¹ng sá»‘ tá»« thuáº§n HÃ n. ì¼ê³± = 7. ì‹œ = giá»."
                    },
                    {
                        id: "lesson5_q2",
                        template: "ì•„ì¹¨ ì—¬ëŸ ì‹œ __ ë¶„ì— ì¶œê·¼í•´ìš”.",
                        translation: "TÃ´i Ä‘i lÃ m lÃºc 8 giá» 30 phÃºt sÃ¡ng",
                        choices: ["ì‚¼ì‹­", "ì„œë¥¸", "ì‚¼", "ì˜¤"],
                        solution: ["ì‚¼ì‹­"],
                        completeSentence: "ì•„ì¹¨ ì—¬ëŸ ì‹œ ì‚¼ì‹­ ë¶„ì— ì¶œê·¼í•´ìš”",
                        explanation: "Khi nÃ³i vá» phÃºt, ta dÃ¹ng sá»‘ tá»« HÃ¡n-Triá»u. ì‚¼ì‹­ = 30. ë¶„ = phÃºt."
                    },
                    {
                        id: "lesson5_q3",
                        template: "ì ì‹¬ì„ ì—´ë‘ ì‹œì— __.",
                        translation: "TÃ´i Äƒn trÆ°a lÃºc 12 giá»",
                        choices: ["ë¨¹ì–´ìš”", "ë¨¹ë‹¤", "ë¨¹ìŠµë‹ˆë‹¤", "ë¨¹ì–´"],
                        solution: ["ë¨¹ì–´ìš”"],
                        completeSentence: "ì ì‹¬ì„ ì—´ë‘ ì‹œì— ë¨¹ì–´ìš”",
                        explanation: "ë¨¹ë‹¤ (Äƒn) + ì–´ìš” = ë¨¹ì–´ìš”. ÄÃ¢y lÃ  thá»ƒ lá»‹ch sá»± hiá»‡n táº¡i."
                    },
                    {
                        id: "lesson5_q4",
                        template: "íšŒì‚¬__ ê°€ìš”.",
                        translation: "TÃ´i Ä‘i Ä‘áº¿n cÃ´ng ty",
                        choices: ["ì—", "ì—ì„œ", "ë¥¼", "ê³¼"],
                        solution: ["ì—"],
                        completeSentence: "íšŒì‚¬ì— ê°€ìš”",
                        explanation: "ì— lÃ  trá»£ tá»« chá»‰ Ä‘á»‹a Ä‘iá»ƒm Ä‘áº¿n. íšŒì‚¬ì— ê°€ë‹¤ = Ä‘i Ä‘áº¿n cÃ´ng ty."
                    },
                    {
                        id: "lesson5_q5",
                        template: "ì˜¤ëŠ˜ì€ í•™êµì— __ ê°€ìš”.",
                        translation: "HÃ´m nay tÃ´i khÃ´ng Ä‘i há»c",
                        choices: ["ì•ˆ", "ëª»", "ì˜", "ë˜"],
                        solution: ["ì•ˆ"],
                        completeSentence: "ì˜¤ëŠ˜ì€ í•™êµì— ì•ˆ ê°€ìš”",
                        explanation: "ì•ˆ lÃ  tá»« phá»§ Ä‘á»‹nh Ä‘áº·t trÆ°á»›c Ä‘á»™ng tá»«. ì•ˆ ê°€ìš” = khÃ´ng Ä‘i."
                    },
                    {
                        id: "lesson5_q6",
                        template: "ì €ë…ì— __ ì‹œì— ì§‘ì— ì™€ìš”.",
                        translation: "Tá»‘i tÃ´i vá» nhÃ  lÃºc 6 giá»",
                        choices: ["ì—¬ì„¯", "ìœ¡", "ì—¿", "ì—¬ëœ"],
                        solution: ["ì—¬ì„¯"],
                        completeSentence: "ì €ë…ì— ì—¬ì„¯ ì‹œì— ì§‘ì— ì™€ìš”",
                        explanation: "ì—¬ì„¯ = 6 (sá»‘ tá»« thuáº§n HÃ n). Khi nÃ³i giá» ta dÃ¹ng sá»‘ tá»« thuáº§n HÃ n."
                    },
                    {
                        id: "lesson5_q7",
                        template: "__ ê°œ ìƒ€ì–´ìš”.",
                        translation: "TÃ´i Ä‘Ã£ mua 3 cÃ¡i",
                        choices: ["ì„¸", "ì…‹", "ì‚¼", "ì„"],
                        solution: ["ì„¸"],
                        completeSentence: "ì„¸ ê°œ ìƒ€ì–´ìš”",
                        explanation: "Khi Ä‘áº¿m Ä‘á»“ váº­t, ta dÃ¹ng sá»‘ tá»« thuáº§n HÃ n dáº¡ng Ä‘á»‹nh tá»«. ì…‹ â†’ ì„¸ (trÆ°á»›c danh tá»«)."
                    },
                    {
                        id: "lesson5_q8",
                        template: "ë°¤ ì—´í•œ ì‹œì— __.",
                        translation: "TÃ´i ngá»§ lÃºc 11 giá» tá»‘i",
                        choices: ["ììš”", "ìë‹¤", "ì¡ë‹ˆë‹¤", "ì "],
                        solution: ["ììš”"],
                        completeSentence: "ë°¤ ì—´í•œ ì‹œì— ììš”",
                        explanation: "ìë‹¤ (ngá»§) â†’ ììš” (thá»ƒ lá»‹ch sá»±). ì—´í•œ = 11 (sá»‘ thuáº§n HÃ n)."
                    },
                    {
                        id: "lesson5_q9",
                        template: "ìˆ˜ì—…ì´ ì•„í™‰ ì‹œ __ ë¶„ì— ì‹œì‘í•´ìš”.",
                        translation: "Lá»›p há»c báº¯t Ä‘áº§u lÃºc 9 giá» 15 phÃºt",
                        choices: ["ì‹­ì˜¤", "ì—´ë‹¤ì„¯", "ì˜¤", "ì‹­"],
                        solution: ["ì‹­ì˜¤"],
                        completeSentence: "ìˆ˜ì—…ì´ ì•„í™‰ ì‹œ ì‹­ì˜¤ ë¶„ì— ì‹œì‘í•´ìš”",
                        explanation: "ì‹­ì˜¤ = 15 (sá»‘ HÃ¡n-Triá»u). Khi nÃ³i phÃºt ta dÃ¹ng sá»‘ HÃ¡n-Triá»u."
                    },
                    {
                        id: "lesson5_q10",
                        template: "ì•„ì¹¨ì„ __ ë¨¹ì–´ìš”.",
                        translation: "TÃ´i khÃ´ng Äƒn sÃ¡ng",
                        choices: ["ì•ˆ", "ì˜", "ë§ì´", "ì¡°ê¸ˆ"],
                        solution: ["ì•ˆ"],
                        completeSentence: "ì•„ì¹¨ì„ ì•ˆ ë¨¹ì–´ìš”",
                        explanation: "ì•ˆ + ë™ì‚¬ = phá»§ Ä‘á»‹nh. ì•ˆ ë¨¹ì–´ìš” = khÃ´ng Äƒn."
                    }
                ]
            };

            /**
             * Initialize the quiz
             */
            function initializeQuiz() {
                // Check if this is a retake (from localStorage or URL parameter)
                const params = new URLSearchParams(window.location.search);
                isRetake = localStorage.getItem('lesson_lesson5_completed') === 'true' || 
                          params.get('retake') === 'true';

                currentExercises = [...exerciseData.exercises];
                totalQuestions = currentExercises.length;
                currentQuestionIndex = 1;
                correctAnswers = 0; // Reset correct answers count
                
                // If this is a retake, shuffle the questions randomly
                if (isRetake) {
                    currentExercises = shuffleArray(currentExercises);
                    console.log('LÃ m láº¡i bÃ i - CÃ¢u há»i Ä‘Æ°á»£c xÃ¡o trá»™n ngáº«u nhiÃªn');
                } else {
                    console.log('Láº§n Ä‘áº§u lÃ m bÃ i - CÃ¢u há»i theo thá»© tá»±');
                }
                
                // Update question counter
                updateQuestionCounter();

                // Track page view
                if (typeof trackPageView === 'function') {
                    trackPageView('Grammar Exercise Lesson 5', '/grammar-exercise-lesson5.html');
                }

                loadNextQuestion();
            }

            function updateQuestionCounter() {
                questionCounter.textContent = `CÃ¢u ${currentQuestionIndex}/${totalQuestions}`;
            }

            function loadNextQuestion() {
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';
                replayAudioBtn.style.display = 'none'; // áº¨n nÃºt phÃ¡t láº¡i khi táº£i cÃ¢u má»›i
                checkBtn.style.display = 'inline-block';
                nextBtn.disabled = true; // Disable next button until check is clicked
                hasAnswered = false;

                // Get current question based on index (no random selection)
                currentQuestion = currentExercises[currentQuestionIndex - 1];
                
                // Set global reference for audio manager
                window.currentQuestion = currentQuestion;

                // Update question counter
                updateQuestionCounter();

                // Update button text based on current question index
                if (currentQuestionIndex === totalQuestions) {
                    nextBtn.textContent = 'Káº¿t thÃºc';
                } else {
                    nextBtn.textContent = 'CÃ¢u tiáº¿p theo';
                }

                // Clear and rebuild sentence container
                sentenceContainer.innerHTML = '';
                
                // Add translation
                const translationDiv = document.createElement('div');
                translationDiv.className = 'translation-text';
                translationDiv.textContent = currentQuestion.translation;
                sentenceContainer.appendChild(translationDiv);

                // Parse template and create sentence
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-text';
                
                const parts = currentQuestion.template.split('__');
                
                for (let i = 0; i < parts.length; i++) {
                    if (parts[i]) {
                        const textNode = document.createTextNode(parts[i]);
                        sentenceDiv.appendChild(textNode);
                    }
                    
                    // Add blank after each part except the last one
                    if (i < parts.length - 1) {
                        const blank = document.createElement('span');
                        blank.className = 'blank';
                        blank.onclick = () => handleBlankClick(blank);
                        sentenceDiv.appendChild(blank);
                    }
                }
                
                sentenceContainer.appendChild(sentenceDiv);

                // Build word bank
                buildWordBank();

                // Hide next button and show check button
                nextBtn.style.display = 'none';
                checkBtn.style.display = 'inline-block';
            }

            function buildWordBank() {
                wordBank.innerHTML = '';
                
                // Shuffle choices for each question
                const shuffledChoices = [...currentQuestion.choices].sort(() => Math.random() - 0.5);
                
                shuffledChoices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'word-btn';
                    btn.textContent = choice;
                    btn.onclick = () => handleWordSelection(btn);
                    wordBank.appendChild(btn);
                });
            }

            // Move these functions to global scope for onclick access
            window.handleWordSelection = function(wordBtn) {
                if (hasAnswered) return; // Prevent changes after answering

                const blanks = sentenceContainer.querySelectorAll('.blank');
                const emptyBlank = Array.from(blanks).find(blank => !blank.textContent || blank.textContent === '?');
                
                if (emptyBlank) {
                    emptyBlank.textContent = wordBtn.textContent;
                    emptyBlank.dataset.selectedWord = wordBtn.textContent;
                    wordBtn.disabled = true;
                }
            };
            
            window.handleBlankClick = function(clickedBlank) {
                if (hasAnswered) return; // Prevent changes after answering

                const selectedWord = clickedBlank.dataset.selectedWord;
                if (selectedWord) {
                    // Re-enable the word button
                    const wordBtns = wordBank.querySelectorAll('.word-btn');
                    wordBtns.forEach(btn => {
                        if (btn.textContent === selectedWord && btn.disabled) {
                            btn.disabled = false;
                        }
                    });
                    
                    // Clear the blank
                    clickedBlank.textContent = '';
                    delete clickedBlank.dataset.selectedWord;
                }
            };

            function playCurrentQuestionAudio() {
                if (!currentQuestion) return;
                
                // Use the new grammar audio manager with dual voice support
                window.grammarAudioManager.playQuestionAudio(currentQuestion.id);
            }

            function checkAnswers() {
                if (hasAnswered) return;

                const blanks = sentenceContainer.querySelectorAll('.blank');
                const userAnswers = Array.from(blanks).map(blank => blank.textContent || '');
                
                // Check if all blanks are filled
                if (userAnswers.some(answer => !answer || answer === '?')) {
                    alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ cÃ¡c chá»— trá»‘ng!');
                    return;
                }
                
                hasAnswered = true;
                
                // Check correctness
                const isCorrect = JSON.stringify(userAnswers) === JSON.stringify(currentQuestion.solution);
                
                // Update UI based on correctness
                blanks.forEach((blank, index) => {
                    const isBlankCorrect = userAnswers[index] === currentQuestion.solution[index];
                    blank.classList.add(isBlankCorrect ? 'correct' : 'incorrect');
                });
                
                // Show feedback
                feedbackEl.style.display = 'block';
                if (isCorrect) {
                    feedbackEl.className = 'feedback success';
                    feedbackEl.textContent = 'ğŸ‰ ChÃ­nh xÃ¡c! Tuyá»‡t vá»i!';
                    correctAnswers++;
                } else {
                    feedbackEl.className = 'feedback error';
                    feedbackEl.innerHTML = `âŒ ChÆ°a Ä‘Ãºng. ÄÃ¡p Ã¡n: <strong>${currentQuestion.completeSentence}</strong>`;
                }
                
                // Show explanation
                if (currentQuestion.explanation) {
                    explanationEl.style.display = 'block';
                    explanationEl.innerHTML = `<h4>ğŸ’¡ Giáº£i thÃ­ch:</h4><p>${currentQuestion.explanation}</p>`;
                }
                
                // Hide check button, show next button
                checkBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                nextBtn.disabled = false;
                
                // Show replay audio button
                replayAudioBtn.style.display = 'block';
                
                // Disable all word buttons
                const wordBtns = wordBank.querySelectorAll('.word-btn');
                wordBtns.forEach(btn => btn.disabled = true);

                // Play correct pronunciation using audio manager
                setTimeout(() => {
                    playCurrentQuestionAudio();
                }, 1000);
            }

            function showResultsPage() {
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                const passed = percentage >= 70;

                // Track completion
                if (typeof trackEvent === 'function') {
                    trackEvent('Grammar Exercise Lesson 5', 'Complete', `Score: ${percentage}%`);
                }

                // Save completion status
                if (passed) {
                    localStorage.setItem('lesson_lesson5_completed', 'true');
                }

                // Create results content
                document.getElementById('quiz-container').innerHTML = `
                    <div class="results-content">
                        <div class="completion-icon" style="font-size: 4rem; margin-bottom: 20px;">
                            ${passed ? 'ğŸ‰' : 'ğŸ“š'}
                        </div>
                        <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.8rem;">
                            ${passed ? 'ChÃºc má»«ng!' : 'HÃ£y cá»‘ gáº¯ng thÃªm!'}
                        </h2>
                        <div style="font-size: 1.2rem; margin-bottom: 25px;">
                            <div style="color: #333; margin-bottom: 10px;">
                                Káº¿t quáº£: <strong style="color: ${passed ? '#28a745' : '#dc3545'};">${correctAnswers}/${totalQuestions}</strong>
                            </div>
                            <div style="color: #667eea; font-weight: 600; font-size: 1.5rem;">
                                ${percentage}%
                            </div>
                        </div>
                        
                        ${passed ? 
                            '<div style="color: #28a745; margin-bottom: 25px; font-weight: 500;">âœ… Báº¡n Ä‘Ã£ hoÃ n thÃ nh xuáº¥t sáº¯c bÃ i táº­p nÃ y!</div>' : 
                            '<div style="color: #dc3545; margin-bottom: 25px; font-weight: 500;">ğŸ“– HÃ£y Ã´n láº¡i lÃ½ thuyáº¿t vÃ  thá»­ láº¡i!</div>'
                        }
                        
                        <div class="results-actions" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="restartLesson()" class="btn btn-primary" style="min-width: 120px;">
                                ğŸ”„ LÃ m láº¡i
                            </button>
                            <button onclick="goToIndex()" class="btn btn-secondary" style="min-width: 120px;">
                                ğŸ  Trang chá»§
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- EVENT LISTENERS ---
            checkBtn.addEventListener('click', checkAnswers);
            replayAudioBtn.addEventListener('click', playCurrentQuestionAudio);
            nextBtn.addEventListener('click', function() {
                if (currentQuestionIndex < totalQuestions) {
                    currentQuestionIndex++;
                    loadNextQuestion();
                } else {
                    showResultsPage();
                }
            });

            // --- INITIALIZE QUIZ ---
            initializeQuiz();
        });

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function restartLesson() {
            const params = new URLSearchParams(window.location.search);
            params.set('retake', 'true');
            window.location.href = window.location.pathname + '?' + params.toString();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
    </script>
</body>
</html>
