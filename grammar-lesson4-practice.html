<!DOCTYPE html>
<html lang="vi">
<head>
    <script src="analytics.js"></script>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BÃ i táº­p Ngá»¯ phÃ¡p BÃ i 4 - Tiáº¿ng HÃ n Hyewon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Common CSS -->
    <link rel="stylesheet" href="css/grammar-common.css">
    <link rel="stylesheet" href="css/grammar-exercise.css">
</head>
<body>
    <div class="header-bar">
        <button class="back-button" onclick="goToIndex()">
            <span class="back-arrow">â†</span>
            <span>Quay láº¡i</span>
        </button>
        <span id="lesson-name" class="lesson-title">BÃ i 4: NgÃ y vÃ  Thá»©</span>
    </div>

    <div id="quiz-container" class="main-container text-center">
        <div id="question-counter" class="question-counter">CÃ¢u 1/10</div>
        <div class="question-container">
            <button id="replay-audio-btn" style="display: none;">ğŸ”Š</button>
            <div id="sentence-container" class="korean-text sentence-text leading-loose">
            </div>
        </div>
        <div id="word-bank" class="word-bank"></div>
        <div class="controls">
            <button id="check-btn" class="btn btn-primary">Kiá»ƒm tra</button>
            <button id="next-btn" class="btn btn-primary">CÃ¢u tiáº¿p theo</button>
        </div>
        <div id="feedback" class="feedback" style="display: none;"></div>
        <div id="explanation" class="explanation" style="display: none;"></div>
    </div>

    <!-- Common JavaScript -->
    <script src="js/grammar-common.js"></script>
    <script src="js/grammar-audio-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load voices for speech synthesis
            if ('speechSynthesis' in window) {
                // Load voices
                let voices = window.speechSynthesis.getVoices();
                
                // If voices are not loaded yet, wait for the voiceschanged event
                if (voices.length === 0) {
                    window.speechSynthesis.addEventListener('voiceschanged', function() {
                        voices = window.speechSynthesis.getVoices();
                        console.log('Available voices loaded:', voices.filter(v => v.lang.startsWith('ko')).length, 'Korean voices');
                    });
                } else {
                    console.log('Available voices:', voices.filter(v => v.lang.startsWith('ko')).length, 'Korean voices');
                }
            }

            // --- DOM ELEMENTS ---
            const lessonName = document.getElementById('lesson-name');
            const questionCounter = document.getElementById('question-counter');
            const sentenceContainer = document.getElementById('sentence-container');
            const wordBank = document.getElementById('word-bank');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const explanationEl = document.getElementById('explanation');
            const replayAudioBtn = document.getElementById('replay-audio-btn');

            // --- APP STATE ---
            let currentExercises = [];
            let currentQuestion = null;
            let hasAnswered = false;
            let currentQuestionIndex = 0;
            let totalQuestions = 0;
            let correctAnswers = 0; // Track correct answers count
            let isRetake = false; // Track if this is a retake

            // Lesson 4 Exercise data
            const exerciseData = {
                title: "BÃ i 4: NgÃ y vÃ  Thá»©",
                exercises: [
                    {
                        id: "lesson4_q1",
                        template: "ì €ëŠ” ì›”ìš”ì¼ __ í•™êµì— ê°‘ë‹ˆë‹¤.",
                        translation: "TÃ´i Ä‘i Ä‘áº¿n trÆ°á»ng vÃ o thá»© Hai",
                        choices: ["ì—", "ì—ì„œ", "ìœ¼ë¡œ", "í•˜ê³ "],
                        solution: ["ì—"],
                        completeSentence: "ì €ëŠ” ì›”ìš”ì¼ì— í•™êµì— ê°‘ë‹ˆë‹¤",
                        explanation: "ì— dÃ¹ng sau danh tá»« chá»‰ thá»i gian: ì›”ìš”ì¼ì— = vÃ o thá»© Hai."
                    },
                    {
                        id: "lesson4_q2",
                        template: "ì¹œêµ¬ëŠ” 9ì‹œ __ ì˜µë‹ˆë‹¤.",
                        translation: "Báº¡n Ä‘áº¿n lÃºc 9 giá»",
                        choices: ["ì—", "ì—ê²Œ", "ì™€", "ë„"],
                        solution: ["ì—"],
                        completeSentence: "ì¹œêµ¬ëŠ” 9ì‹œì— ì˜µë‹ˆë‹¤",
                        explanation: "9ì‹œì— = vÃ o lÃºc 9 giá». ì— gáº¯n vÃ o thá»i gian cá»¥ thá»ƒ."
                    },
                    {
                        id: "lesson4_q3",
                        template: "ì•„ë²„ì§€ëŠ” ì•„ì¹¨ 7ì‹œ __ íšŒì‚¬ì— ê°‘ë‹ˆë‹¤",
                        translation: "Bá»‘ Ä‘i cÃ´ng ty lÃºc 7 giá» sÃ¡ng",
                        choices: ["ë„", "ì—", "ë¡œ", "í•˜ê³ "],
                        solution: ["ì—"],
                        completeSentence: "ì•„ë²„ì§€ëŠ” ì•„ì¹¨ 7ì‹œì— íšŒì‚¬ì— ê°‘ë‹ˆë‹¤",
                        explanation: "7ì‹œì— = vÃ o lÃºc 7 giá». ì— chá»‰ thá»i Ä‘iá»ƒm cá»¥ thá»ƒ."
                    },
                    {
                        id: "lesson4_q4",
                        template: "ìš°ë¦¬ëŠ” í† ìš”ì¼ __ ì˜í™”ë¥¼ ë´…ë‹ˆë‹¤.",
                        translation: "ChÃºng tÃ´i xem phim vÃ o thá»© Báº£y",
                        choices: ["ì—ì„œ", "ì—", "ì™€", "ë„"],
                        solution: ["ì—"],
                        completeSentence: "ìš°ë¦¬ëŠ” í† ìš”ì¼ì— ì˜í™”ë¥¼ ë´…ë‹ˆë‹¤",
                        explanation: "í† ìš”ì¼ì— = vÃ o thá»© Báº£y. ì— dÃ¹ng sau danh tá»« chá»‰ thá»i gian."
                    },
                    {
                        id: "lesson4_q5",
                        template: "ì €ëŠ” 12ì›” 25ì¼ __ ì„ ë¬¼ì„ ë°›ìŠµë‹ˆë‹¤",
                        translation: "TÃ´i nháº­n quÃ  vÃ o ngÃ y 25 thÃ¡ng 12",
                        choices: ["ì—", "ë„", "ì—ê²Œ", "ë¡œ"],
                        solution: ["ì—"],
                        completeSentence: "ì €ëŠ” 12ì›” 25ì¼ì— ì„ ë¬¼ì„ ë°›ìŠµë‹ˆë‹¤",
                        explanation: "12ì›” 25ì¼ì— = vÃ o ngÃ y 25 thÃ¡ng 12. ì— chá»‰ thá»i Ä‘iá»ƒm."
                    },
                    {
                        id: "lesson4_q6",
                        template: "ì–¸ë‹ˆëŠ” ì €ë… 6ì‹œ __ ì§‘ì— ì˜µë‹ˆë‹¤.",
                        translation: "Chá»‹ gÃ¡i vá» nhÃ  lÃºc 6 giá» tá»‘i",
                        choices: ["ì—", "ì—ì„œ", "ë¡œ", "í•˜ê³ "],
                        solution: ["ì—"],
                        completeSentence: "ì–¸ë‹ˆëŠ” ì €ë… 6ì‹œì— ì§‘ì— ì˜µë‹ˆë‹¤",
                        explanation: "6ì‹œì— = vÃ o lÃºc 6 giá». ì— gáº¯n vÃ o thá»i gian cá»¥ thá»ƒ."
                    },
                    {
                        id: "lesson4_q7",
                        template: "ìš°ë¦¬ëŠ” ì¼ìš”ì¼ ì•„ì¹¨ __ ìš´ë™ì„ í•©ë‹ˆë‹¤.",
                        translation: "ChÃºng tÃ´i táº­p thá»ƒ dá»¥c vÃ o sÃ¡ng Chá»§ nháº­t",
                        choices: ["ì—", "ì—ì„œ", "ë¡œ", "ë„"],
                        solution: ["ì—"],
                        completeSentence: "ìš°ë¦¬ëŠ” ì¼ìš”ì¼ ì•„ì¹¨ì— ìš´ë™ì„ í•©ë‹ˆë‹¤",
                        explanation: "ì¼ìš”ì¼ ì•„ì¹¨ì— = vÃ o sÃ¡ng Chá»§ nháº­t. ì— dÃ¹ng sau thá»i gian."
                    },
                    {
                        id: "lesson4_q8",
                        template: "__.",
                        translation: "Chá»n cÃ¢u Ä‘Ãºng: TÃ´i Ä‘á»c sÃ¡ch vÃ o Chá»§ nháº­t",
                        choices: ["ì €ëŠ” ì¼ìš”ì¼ ì±…ì„ ì½ìŠµë‹ˆë‹¤.", "ì €ëŠ” ì¼ìš”ì¼ì— ì±…ì„ ì½ìŠµë‹ˆë‹¤.", "ì €ëŠ” ì¼ìš”ì¼ì—ì„œ ì±…ì„ ì½ìŠµë‹ˆë‹¤.", "ì €ëŠ” ì¼ìš”ì¼í•˜ê³  ì±…ì„ ì½ìŠµë‹ˆë‹¤."],
                        solution: ["ì €ëŠ” ì¼ìš”ì¼ì— ì±…ì„ ì½ìŠµë‹ˆë‹¤."],
                        completeSentence: "ì €ëŠ” ì¼ìš”ì¼ì— ì±…ì„ ì½ìŠµë‹ˆë‹¤",
                        explanation: "ì¼ìš”ì¼ì— = vÃ o Chá»§ nháº­t. Pháº£i dÃ¹ng ì— sau thá»i gian."
                    },
                    {
                        id: "lesson4_q9",
                        template: "__.",
                        translation: "Chá»n cÃ¢u sai: TÃ´i ngá»§ lÃºc 10 giá» tá»‘i",
                        choices: ["ì €ëŠ” ë°¤ 10ì‹œì— ììŠµë‹ˆë‹¤.", "ì €ëŠ” ë°¤ 10ì‹œ ì— ì¡ë‹ˆë‹¤.", "ì €ëŠ” ë°¤ 10ì‹œì—ì„œ ì¡ë‹ˆë‹¤", "ì €ëŠ” ë°¤ 10ì‹œ ì”ë‹¤."],
                        solution: ["ì €ëŠ” ë°¤ 10ì‹œì—ì„œ ì¡ë‹ˆë‹¤"],
                        completeSentence: "ì €ëŠ” ë°¤ 10ì‹œì— ì¡ë‹ˆë‹¤",
                        explanation: "ì—ì„œ khÃ´ng dÃ¹ng vá»›i thá»i gian. ÄÃºng pháº£i lÃ  10ì‹œì— (vÃ o lÃºc 10 giá»)."
                    },
                    {
                        id: "lesson4_q10",
                        template: "ë‚´ì¼ì€ í•œêµ­ì–´ ì‹œí—˜ì´ ìˆìŠµë‹ˆë‹¤. ì €ëŠ” ì•„ì¹¨ 8ì‹œ __ í•™êµì—ê°‘ë‹ˆë‹¤.",
                        translation: "Mai cÃ³ thi tiáº¿ng HÃ n. TÃ´i Ä‘i Ä‘áº¿n trÆ°á»ng lÃºc 8 giá» sÃ¡ng",
                        choices: ["ì—", "ë¡œ", "í•˜ê³ ", "ì—ì„œ"],
                        solution: ["ì—"],
                        completeSentence: "ì €ëŠ” ì•„ì¹¨ 8ì‹œì— í•™êµì— ê°‘ë‹ˆë‹¤",
                        explanation: "8ì‹œì— = vÃ o lÃºc 8 giá». ì— chá»‰ thá»i Ä‘iá»ƒm cá»¥ thá»ƒ."
                    }
                ]
            };

            /**
             * Initialize the quiz
             */
            function initializeQuiz() {
                // Check if this is a retake (from localStorage or URL parameter)
                const params = new URLSearchParams(window.location.search);
                isRetake = localStorage.getItem('lesson_lesson4_completed') === 'true' || 
                          params.get('retake') === 'true';

                currentExercises = [...exerciseData.exercises];
                totalQuestions = currentExercises.length;
                currentQuestionIndex = 1;
                correctAnswers = 0; // Reset correct answers count
                
                // If this is a retake, shuffle the questions randomly
                if (isRetake) {
                    currentExercises = shuffleArray(currentExercises);
                    console.log('LÃ m láº¡i bÃ i - CÃ¢u há»i Ä‘Æ°á»£c xÃ¡o trá»™n ngáº«u nhiÃªn');
                } else {
                    console.log('Láº§n Ä‘áº§u lÃ m bÃ i - CÃ¢u há»i theo thá»© tá»±');
                }
                
                // Update question counter
                updateQuestionCounter();

                // Track page view
                if (typeof trackPageView === 'function') {
                    trackPageView('Grammar Exercise Lesson 4', '/grammar-exercise-lesson4.html');
                }

                loadNextQuestion();
            }

            function updateQuestionCounter() {
                questionCounter.textContent = `CÃ¢u ${currentQuestionIndex}/${totalQuestions}`;
            }

            function loadNextQuestion() {
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';
                replayAudioBtn.style.display = 'none'; // áº¨n nÃºt phÃ¡t láº¡i khi táº£i cÃ¢u má»›i
                checkBtn.style.display = 'inline-block';
                nextBtn.disabled = true; // Disable next button until check is clicked
                hasAnswered = false;

                // Get current question based on index (no random selection)
                currentQuestion = currentExercises[currentQuestionIndex - 1];
                
                // Set global reference for audio manager
                window.currentQuestion = currentQuestion;

                // Update question counter
                updateQuestionCounter();

                // Update button text based on current question index
                if (currentQuestionIndex === totalQuestions) {
                    nextBtn.textContent = 'Káº¿t thÃºc';
                } else {
                    nextBtn.textContent = 'CÃ¢u tiáº¿p theo';
                }

                // Clear and rebuild sentence container
                sentenceContainer.innerHTML = '';
                
                // Add translation
                const translationDiv = document.createElement('div');
                translationDiv.className = 'translation-text';
                translationDiv.textContent = currentQuestion.translation;
                sentenceContainer.appendChild(translationDiv);

                // Parse template and create sentence
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-text';
                
                const parts = currentQuestion.template.split('__');
                
                for (let i = 0; i < parts.length; i++) {
                    if (parts[i]) {
                        const textNode = document.createTextNode(parts[i]);
                        sentenceDiv.appendChild(textNode);
                    }
                    
                    // Add blank after each part except the last one
                    if (i < parts.length - 1) {
                        const blank = document.createElement('span');
                        blank.className = 'blank';
                        blank.onclick = () => handleBlankClick(blank);
                        sentenceDiv.appendChild(blank);
                    }
                }
                
                sentenceContainer.appendChild(sentenceDiv);

                // Build word bank
                buildWordBank();

                // Hide next button and show check button
                nextBtn.style.display = 'none';
                checkBtn.style.display = 'inline-block';
            }

            function buildWordBank() {
                wordBank.innerHTML = '';
                
                // Shuffle choices for each question
                const shuffledChoices = [...currentQuestion.choices].sort(() => Math.random() - 0.5);
                
                shuffledChoices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'word-btn';
                    btn.textContent = choice;
                    btn.onclick = () => handleWordSelection(btn);
                    wordBank.appendChild(btn);
                });
            }

            function handleWordSelection(wordBtn) {
                if (hasAnswered) return; // Prevent changes after answering

                const blanks = sentenceContainer.querySelectorAll('.blank');
                const emptyBlank = Array.from(blanks).find(blank => !blank.textContent || blank.textContent === '?');
                
                if (emptyBlank) {
                    emptyBlank.textContent = wordBtn.textContent;
                    emptyBlank.dataset.selectedWord = wordBtn.textContent;
                    wordBtn.disabled = true;
                }
            }
            
            function handleBlankClick(clickedBlank) {
                if (hasAnswered) return; // Prevent changes after answering

                const selectedWord = clickedBlank.dataset.selectedWord;
                if (selectedWord) {
                    // Re-enable the word button
                    const wordBtns = wordBank.querySelectorAll('.word-btn');
                    wordBtns.forEach(btn => {
                        if (btn.textContent === selectedWord && btn.disabled) {
                            btn.disabled = false;
                        }
                    });
                    
                    // Clear the blank
                    clickedBlank.textContent = '';
                    delete clickedBlank.dataset.selectedWord;
                }
            }

            function playCurrentQuestionAudio() {
                if (!currentQuestion) return;
                
                // Use the new grammar audio manager with dual voice support
                window.grammarAudioManager.playQuestionAudio(currentQuestion.id);
            }

            function checkAnswers() {
                if (hasAnswered) return;

                const blanks = sentenceContainer.querySelectorAll('.blank');
                const userAnswers = Array.from(blanks).map(blank => blank.textContent || '');
                
                // Check if all blanks are filled
                if (userAnswers.some(answer => !answer || answer === '?')) {
                    alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ cÃ¡c chá»— trá»‘ng!');
                    return;
                }
                
                hasAnswered = true;
                
                // Check correctness
                const isCorrect = JSON.stringify(userAnswers) === JSON.stringify(currentQuestion.solution);
                
                // Update UI based on correctness
                blanks.forEach((blank, index) => {
                    const isBlankCorrect = userAnswers[index] === currentQuestion.solution[index];
                    blank.classList.add(isBlankCorrect ? 'correct' : 'incorrect');
                });
                
                // Show feedback
                feedbackEl.style.display = 'block';
                if (isCorrect) {
                    feedbackEl.className = 'feedback success';
                    feedbackEl.textContent = 'ğŸ‰ ChÃ­nh xÃ¡c! Tuyá»‡t vá»i!';
                    correctAnswers++;
                } else {
                    feedbackEl.className = 'feedback error';
                    feedbackEl.innerHTML = `âŒ ChÆ°a Ä‘Ãºng. ÄÃ¡p Ã¡n: <strong>${currentQuestion.completeSentence}</strong>`;
                }
                
                // Show explanation
                if (currentQuestion.explanation) {
                    explanationEl.style.display = 'block';
                    explanationEl.innerHTML = `<h4>ğŸ’¡ Giáº£i thÃ­ch:</h4><p>${currentQuestion.explanation}</p>`;
                }
                
                // Hide check button, show next button
                checkBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                nextBtn.disabled = false;
                
                // Show replay audio button
                replayAudioBtn.style.display = 'block';
                
                // Disable all word buttons
                const wordBtns = wordBank.querySelectorAll('.word-btn');
                wordBtns.forEach(btn => btn.disabled = true);

                // Play correct pronunciation
                setTimeout(() => {
                    if (currentQuestion && currentQuestion.id) {
                        const audioPath = `audio/sentences/${currentQuestion.id}.mp3`;
                        playAudioFile(audioPath).catch(() => {
                            // Fallback to text-to-speech
                            if (currentQuestion.completeSentence) {
                                playTextToSpeech(currentQuestion.completeSentence);
                            }
                        });
                    }
                }, 1000);
            }

            function showResultsPage() {
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                const passed = percentage >= 70;

                // Track completion
                if (typeof trackEvent === 'function') {
                    trackEvent('Grammar Exercise Lesson 4', 'Complete', `Score: ${percentage}%`);
                }

                // Save completion status
                if (passed) {
                    localStorage.setItem('lesson_lesson4_completed', 'true');
                }

                // Create results content
                document.getElementById('quiz-container').innerHTML = `
                    <div class="results-content">
                        <div class="completion-icon" style="font-size: 4rem; margin-bottom: 20px;">
                            ${passed ? 'ğŸ‰' : 'ğŸ“š'}
                        </div>
                        <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.8rem;">
                            ${passed ? 'ChÃºc má»«ng!' : 'HÃ£y cá»‘ gáº¯ng thÃªm!'}
                        </h2>
                        <div style="font-size: 1.2rem; margin-bottom: 25px;">
                            <div style="color: #333; margin-bottom: 10px;">
                                Káº¿t quáº£: <strong style="color: ${passed ? '#28a745' : '#dc3545'};">${correctAnswers}/${totalQuestions}</strong>
                            </div>
                            <div style="color: #667eea; font-weight: 600; font-size: 1.5rem;">
                                ${percentage}%
                            </div>
                        </div>
                        
                        ${passed ? 
                            '<div style="color: #28a745; margin-bottom: 25px; font-weight: 500;">âœ… Báº¡n Ä‘Ã£ hoÃ n thÃ nh xuáº¥t sáº¯c bÃ i táº­p nÃ y!</div>' : 
                            '<div style="color: #dc3545; margin-bottom: 25px; font-weight: 500;">ğŸ“– HÃ£y Ã´n láº¡i lÃ½ thuyáº¿t vÃ  thá»­ láº¡i!</div>'
                        }
                        
                        <div class="results-actions" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="restartLesson()" class="btn btn-primary" style="min-width: 120px;">
                                ğŸ”„ LÃ m láº¡i
                            </button>
                            <button onclick="goToIndex()" class="btn btn-secondary" style="min-width: 120px;">
                                ğŸ  Trang chá»§
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- EVENT LISTENERS ---
            checkBtn.addEventListener('click', checkAnswers);
            replayAudioBtn.addEventListener('click', playCurrentQuestionAudio);
            nextBtn.addEventListener('click', function() {
                if (currentQuestionIndex < totalQuestions) {
                    currentQuestionIndex++;
                    loadNextQuestion();
                } else {
                    showResultsPage();
                }
            });

            // --- INITIALIZE QUIZ ---
            initializeQuiz();
        });

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function restartLesson() {
            const params = new URLSearchParams(window.location.search);
            params.set('retake', 'true');
            window.location.href = window.location.pathname + '?' + params.toString();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
    </script>
</body>
</html>
