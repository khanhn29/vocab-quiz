<!DOCTYPE html>
<html lang="vi">
<head>
    <script src="analytics.js"></script>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>B√†i t·∫≠p Ng·ªØ ph√°p B√†i 3 - Ti·∫øng H√†n Hyewon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Common CSS -->
    <link rel="stylesheet" href="css/grammar-common.css">
    <link rel="stylesheet" href="css/grammar-exercise.css">
</head>
<body>
    <div class="header-bar">
        <button class="back-button" onclick="goToIndex()">
            <span class="back-arrow">‚Üê</span>
            <span>Quay l·∫°i</span>
        </button>
        <span id="lesson-name" class="lesson-title">B√†i 3: Sinh ho·∫°t h·∫±ng ng√†y</span>
    </div>

    <div id="quiz-container" class="main-container text-center">
        <div id="question-counter" class="question-counter">C√¢u 1/10</div>
        <div class="question-container">
            <button id="replay-audio-btn" style="display: none;">üîä</button>
            <div id="sentence-container" class="korean-text sentence-text leading-loose">
            </div>
        </div>
        <div id="word-bank" class="word-bank"></div>
        <div class="controls">
            <button id="check-btn" class="btn btn-primary">Ki·ªÉm tra</button>
            <button id="next-btn" class="btn btn-primary">C√¢u ti·∫øp theo</button>
        </div>
        <div id="feedback" class="feedback" style="display: none;"></div>
        <div id="explanation" class="explanation" style="display: none;"></div>
    </div>

    <!-- Common JavaScript -->
    <script src="js/grammar-common.js"></script>
    <script src="js/grammar-audio-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load voices for speech synthesis
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }

            // --- DOM ELEMENTS ---
            const lessonName = document.getElementById('lesson-name');
            const questionCounter = document.getElementById('question-counter');
            const sentenceContainer = document.getElementById('sentence-container');
            const wordBank = document.getElementById('word-bank');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const explanationEl = document.getElementById('explanation');
            const replayAudioBtn = document.getElementById('replay-audio-btn');

            // --- APP STATE ---
            let currentExercises = [];
            let currentQuestion = null;
            let hasAnswered = false;
            let currentQuestionIndex = 0;
            let totalQuestions = 0;
            let correctAnswers = 0; // Track correct answers count
            let isRetake = false; // Track if this is a retake

            // Lesson 3 Exercise data
            const exerciseData = {
                title: "B√†i 3: Sinh ho·∫°t h·∫±ng ng√†y",
                exercises: [
                    {
                        id: "lesson3_q1",
                        template: "Ï†ÄÎäî Ïª§Ìîº___ ÎßàÏã≠ÎãàÎã§.",
                        translation: "T√¥i u·ªëng c√† ph√™",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["Î•º"],
                        completeSentence: "Ï†ÄÎäî Ïª§ÌîºÎ•º ÎßàÏã≠ÎãàÎã§",
                        explanation: "Ïª§Ìîº k·∫øt th√∫c b·∫±ng nguy√™n √¢m „Ö£ ‚Üí d√πng Î•º (t√¢n ng·ªØ)."
                    },
                    {
                        id: "lesson3_q2",
                        template: "ÌïôÍµê___ Í∞ëÎãàÎã§.",
                        translation: "ƒêi ƒë·∫øn tr∆∞·ªùng",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["Ïóê"],
                        completeSentence: "ÌïôÍµêÏóê Í∞ëÎãàÎã§",
                        explanation: "Ïóê ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·ªâ h∆∞·ªõng ƒë√≠ch ƒë·∫øn (ƒëi ƒë·∫øn ƒë√¢u)."
                    },
                    {
                        id: "lesson3_q3",
                        template: "ÎèÑÏÑúÍ¥Ä___ Ï±ÖÏùÑ ÏùΩÏäµÎãàÎã§.",
                        translation: "ƒê·ªçc s√°ch ·ªü th∆∞ vi·ªán",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["ÏóêÏÑú"],
                        completeSentence: "ÎèÑÏÑúÍ¥ÄÏóêÏÑú Ï±ÖÏùÑ ÏùΩÏäµÎãàÎã§",
                        explanation: "ÏóêÏÑú ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·ªâ ƒë·ªãa ƒëi·ªÉm x·∫£y ra h√†nh ƒë·ªông."
                    },
                    {
                        id: "lesson3_q4",
                        template: "Î∞•___ Î®πÏäµÎãàÎã§.",
                        translation: "ƒÇn c∆°m",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["ÏùÑ"],
                        completeSentence: "Î∞•ÏùÑ Î®πÏäµÎãàÎã§",
                        explanation: "Î∞• k·∫øt th√∫c b·∫±ng ph·ª• √¢m „ÖÇ ‚Üí d√πng ÏùÑ (t√¢n ng·ªØ)."
                    },
                    {
                        id: "lesson3_q5",
                        template: "Ïßë___ ÎèåÏïÑÍ∞ëÎãàÎã§.",
                        translation: "V·ªÅ nh√†",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["Ïóê"],
                        completeSentence: "ÏßëÏóê ÎèåÏïÑÍ∞ëÎãàÎã§",
                        explanation: "Ïóê ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·ªâ h∆∞·ªõng ƒë√≠ch ƒë·∫øn (v·ªÅ ƒë√¢u)."
                    },
                    {
                        id: "lesson3_q6",
                        template: "ÏπúÍµ¨___ ÎßåÎÇ©ÎãàÎã§.",
                        translation: "G·∫∑p b·∫°n",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["Î•º"],
                        completeSentence: "ÏπúÍµ¨Î•º ÎßåÎÇ©ÎãàÎã§",
                        explanation: "ÏπúÍµ¨ k·∫øt th√∫c b·∫±ng nguy√™n √¢m „Öú ‚Üí d√πng Î•º (t√¢n ng·ªØ)."
                    },
                    {
                        id: "lesson3_q7",
                        template: "Ïπ¥Ìéò___ Ïª§ÌîºÎ•º ÎßàÏã≠ÎãàÎã§.",
                        translation: "U·ªëng c√† ph√™ ·ªü qu√°n c√† ph√™",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["ÏóêÏÑú"],
                        completeSentence: "Ïπ¥ÌéòÏóêÏÑú Ïª§ÌîºÎ•º ÎßàÏã≠ÎãàÎã§",
                        explanation: "ÏóêÏÑú ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·ªâ ƒë·ªãa ƒëi·ªÉm x·∫£y ra h√†nh ƒë·ªông."
                    },
                    {
                        id: "lesson3_q8",
                        template: "ÏùåÏïÖ___ Îì£ÏäµÎãàÎã§.",
                        translation: "Nghe nh·∫°c",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["ÏùÑ"],
                        completeSentence: "ÏùåÏïÖÏùÑ Îì£ÏäµÎãàÎã§",
                        explanation: "ÏùåÏïÖ k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñ± ‚Üí d√πng ÏùÑ (t√¢n ng·ªØ)."
                    },
                    {
                        id: "lesson3_q9",
                        template: "ÏòÅÌôîÍ¥Ä___ ÏòÅÌôîÎ•º Î¥ÖÎãàÎã§.",
                        translation: "Xem phim ·ªü r·∫°p chi·∫øu phim",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["ÏóêÏÑú"],
                        completeSentence: "ÏòÅÌôîÍ¥ÄÏóêÏÑú ÏòÅÌôîÎ•º Î¥ÖÎãàÎã§",
                        explanation: "ÏóêÏÑú ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·ªâ ƒë·ªãa ƒëi·ªÉm x·∫£y ra h√†nh ƒë·ªông."
                    },
                    {
                        id: "lesson3_q10",
                        template: "Î¨º___ ÎßàÏã≠ÎãàÎã§.",
                        translation: "U·ªëng n∆∞·ªõc",
                        choices: ["ÏùÑ", "Î•º", "Ïóê", "ÏóêÏÑú"],
                        solution: ["ÏùÑ"],
                        completeSentence: "Î¨ºÏùÑ ÎßàÏã≠ÎãàÎã§",
                        explanation: "Î¨º k·∫øt th√∫c b·∫±ng ph·ª• √¢m „Ñπ ‚Üí d√πng ÏùÑ (t√¢n ng·ªØ)."
                    }
                ]
            };

            /**
             * Initialize the quiz
             */
            function initializeQuiz() {
                // Check if this is a retake (from localStorage or URL parameter)
                const params = new URLSearchParams(window.location.search);
                isRetake = localStorage.getItem('lesson_lesson3_completed') === 'true' || 
                          params.get('retake') === 'true';
                
                currentExercises = [...exerciseData.exercises];
                totalQuestions = currentExercises.length;
                
                // Shuffle exercises for variety
                if (isRetake || Math.random() > 0.5) {
                    currentExercises = shuffleArray(currentExercises);
                }
                
                loadNextQuestion();
            }

            function updateQuestionCounter() {
                questionCounter.textContent = `C√¢u ${currentQuestionIndex + 1}/${totalQuestions}`;
            }

            function loadNextQuestion() {
                if (currentQuestionIndex >= totalQuestions) {
                    showResultsPage();
                    return;
                }

                currentQuestion = currentExercises[currentQuestionIndex];
                hasAnswered = false;
                
                // Set global reference for audio manager
                window.currentQuestion = currentQuestion;

                // Update counter
                updateQuestionCounter();

                // Build sentence with blanks
                buildSentence();
                
                // Build word bank
                buildWordBank();

                // Reset buttons
                checkBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                
                // Hide feedback and explanation
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';

                // Hide audio button initially - only show after answering
                replayAudioBtn.style.display = 'none';
            }

            function buildSentence() {
                const template = currentQuestion.template;
                const translation = currentQuestion.translation;
                
                // Create sentence with blanks
                let sentenceHtml = template.replace(/_+/g, '<span class="blank" onclick="handleBlankClick(this)"></span>');
                
                sentenceContainer.innerHTML = `
                    <div class="korean-text sentence-text">${sentenceHtml}</div>
                    <div class="translation-text">${translation}</div>
                `;
            }

            function buildWordBank() {
                const choices = shuffleArray([...currentQuestion.choices]);
                
                wordBank.innerHTML = choices.map(choice => 
                    `<button class="word-btn korean-text" onclick="handleWordSelection(this)">${choice}</button>`
                ).join('');
            }

            // Move these functions to global scope
            window.handleWordSelection = function(wordBtn) {
                if (hasAnswered) return;
                
                const word = wordBtn.textContent;
                const blanks = document.querySelectorAll('.blank');
                
                // Find first empty blank
                const emptyBlank = Array.from(blanks).find(blank => !blank.textContent.trim());
                if (emptyBlank) {
                    emptyBlank.textContent = word;
                    wordBtn.disabled = true;
                }
            };
            
            window.handleBlankClick = function(clickedBlank) {
                if (hasAnswered) return;
                
                const word = clickedBlank.textContent.trim();
                if (word) {
                    // Return word to word bank
                    const wordBtns = document.querySelectorAll('.word-btn');
                    const matchingBtn = Array.from(wordBtns).find(btn => btn.textContent === word && btn.disabled);
                    if (matchingBtn) {
                        matchingBtn.disabled = false;
                    }
                    clickedBlank.textContent = '';
                }
            };

            function playCurrentQuestionAudio() {
                if (!currentQuestion) return;
                
                // Use the new grammar audio manager with dual voice support
                window.grammarAudioManager.playQuestionAudio(currentQuestion.id);
            }

            function checkAnswers() {
                if (hasAnswered) return;
                
                const blanks = document.querySelectorAll('.blank');
                const userAnswers = Array.from(blanks).map(blank => blank.textContent.trim());
                const correctSolution = currentQuestion.solution;
                
                hasAnswered = true;
                
                let isCorrect = true;
                blanks.forEach((blank, index) => {
                    const userAnswer = blank.textContent.trim();
                    const correctAnswer = correctSolution[index];
                    
                    if (userAnswer === correctAnswer) {
                        blank.classList.add('correct');
                    } else {
                        blank.classList.add('incorrect');
                        isCorrect = false;
                    }
                });
                
                // Show feedback
                feedbackEl.style.display = 'block';
                if (isCorrect) {
                    feedbackEl.textContent = 'Ï†ïÎãµÏûÖÎãàÎã§! (Ch√≠nh x√°c!)';
                    feedbackEl.className = 'feedback success';
                    correctAnswers++;
                } else {
                    feedbackEl.textContent = 'ÌãÄÎ†∏ÏäµÎãàÎã§. (Sai r·ªìi.)';
                    feedbackEl.className = 'feedback error';
                }
                
                // Show explanation
                explanationEl.style.display = 'block';
                explanationEl.innerHTML = `
                    <h4>Gi·∫£i th√≠ch:</h4>
                    <p><strong>C√¢u ƒë√∫ng:</strong> <span class="korean">${currentQuestion.completeSentence}</span></p>
                    <p>${currentQuestion.explanation}</p>
                `;
                
                // Update buttons
                checkBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                
                // Show audio button and setup click handler
                replayAudioBtn.style.display = 'block';
                replayAudioBtn.onclick = playCurrentQuestionAudio;
                
                // Disable word buttons
                const wordBtns = document.querySelectorAll('.word-btn');
                wordBtns.forEach(btn => btn.disabled = true);
                
                // Auto-play audio after answering
                setTimeout(() => {
                    playCurrentQuestionAudio();
                }, 500);
                
                // Setup next button
                nextBtn.onclick = () => {
                    currentQuestionIndex++;
                    loadNextQuestion();
                };
            }

            function showResultsPage() {
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                const passed = percentage >= 70;
                
                // Save completion status
                if (passed) {
                    localStorage.setItem('lesson_lesson3_completed', 'true');
                }
                
                sentenceContainer.innerHTML = `
                    <div class="results-content">
                        <div class="completion-icon">${passed ? 'üéâ' : 'üìö'}</div>
                        <h2>${passed ? 'Ch√∫c m·ª´ng!' : 'C·∫ßn √¥n t·∫≠p th√™m'}</h2>
                        <p class="results-score">ƒêi·ªÉm s·ªë: ${correctAnswers}/${totalQuestions} (${percentage}%)</p>
                        <p class="results-message">
                            ${passed ? 
                                'B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc b√†i t·∫≠p ng·ªØ ph√°p B√†i 3!' : 
                                'H√£y √¥n t·∫≠p l·∫°i l√Ω thuy·∫øt v√† th·ª≠ l·∫°i nh√©!'
                            }
                        </p>
                        <div class="results-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="restartLesson()">L√†m l·∫°i</button>
                            <button class="btn btn-secondary" onclick="goToIndex()">V·ªÅ trang ch·ªß</button>
                            ${passed ? '<button class="btn btn-primary" onclick="window.location.href=\'grammar-lesson3-theory.html\'">Xem l√Ω thuy·∫øt</button>' : ''}
                        </div>
                    </div>
                `;
                
                // Hide other elements
                wordBank.style.display = 'none';
                document.querySelector('.controls').style.display = 'none';
                feedbackEl.style.display = 'none';
                explanationEl.style.display = 'none';
                replayAudioBtn.style.display = 'none';
                questionCounter.style.display = 'none';
            }

            // --- EVENT LISTENERS ---
            checkBtn.addEventListener('click', checkAnswers);
            initializeQuiz();
        });

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function restartLesson() {
            window.location.reload();
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>
</html>
